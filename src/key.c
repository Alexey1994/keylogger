#include "key.h"

#ifdef WIN32

#include <windows.h>

char key(char key)
{
    if(GetAsyncKeyState(key))
        return 1;
    return 0;
}

#endif //WIN32

#ifdef __linux__

#include <GL/glx.h>

extern Display        *linux_display;
static unsigned char   keymap[32];
static unsigned char   key_table[]={//0    1    2    3    4     5   6    7     8   9    a    b    c    d    e    f
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x27,0x28,0x00,0x00,0x00,0x45,0x00,0x00,//0
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x12,0x00,0x00,0x00,0x00,//1
                                    0x82,0x00,0x00,0xe4,0xd7,0xe2,0xd8,0xe3,0xe5,0x00,0x00,0x00,0x00,0xe7,0xe8,0x00,//2
                                    0x24,0x13,0x14,0x15,0x16,0x17,0x18,0x21,0x22,0x23,0x00,0x00,0x00,0x00,0x00,0x00,//3
                                    0x00,0x47,0x71,0x67,0x51,0x33,0x52,0x53,0x54,0x30,0x55,0x56,0x57,0x73,0x72,0x41,//4
                                    0x42,0x31,0x34,0x48,0x35,0x37,0x60,0x32,0x66,0x36,0x65,0x00,0x00,0x00,0x00,0x00,//5
                                    0xb3,0xa8,0xb1,0xb2,0xa4,0xa5,0xa6,0x98,0xa1,0xa2,0x00,0x00,0x00,0x00,0x00,0x00,//6
                                    0x84,0x85,0x86,0x87,0x88,0x91,0x92,0x93,0x94,0x95,0xb8,0xc1,0x00,0x00,0x00,0x00,//7
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//8
                                    0x96,0x97,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//9
                                    0x63,0x77,0x46,0xd2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//a
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//b
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//c
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//d
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//e
                                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00//f
                                   };

//0x10 0x11
//0x20 0x29
//0X64 0x80 0x89 0x8a 0x8b 0x8c 0x8d 0x8e 0x8f 0x90 0x99 0x9a 0x9b 0x9c 0x9d 0x9e 0x9f 0xa0
//0xa9 0xaa 0xab 0xac 0xad 0xae 0xaf 0xb0 0xb5 0xb6 0xb9 0xba 0xbb 0xbc 0xbd 0xbe 0xbf
//0xc0 0xc2 0xc3 0xc4 0xc5 0xc6 0xc7 0xc8 0xc9 0xca 0xcb 0xcc 0xcd 0xce 0xcf
//0xd0 0xd1 0xd3 0xd4 0xd6 0xd7 0xd9 0xda 0xdb 0xdc 0xdd 0xde 0xdf
//0xe0 0xe9 0xea 0xeb 0xec 0xed 0xee 0xef
//0xf0 0xf5 0xf6 0xf7 0xf8 0xf9 0xfa 0xfb 0xfc 0xfd 0xfe 0xff

//0x43-[
//0x44-]
//0x50 0x58 0x59 0x5a 0x5b 0x5c 0x5d 0x5e 0x5f-;
//0x61-'
//0x62-`
//0x70 0x78 0x79 0x7a 0x7b 0x7d 0x7e 0x7f-NUM*
//0x74-,
//0x75-.
//0x76-/
//0X81-left Alt
//0x83-caps lock
//0xa3-num minus
//0xa7-num plus
//0xb4-num decimal
//0xb7-<
//0xd5-right Alt
//0xe1-pg Up
//0xe6-pg Down
//0xf1-Fn+F4
//0xf2-Mute (Fn+End)
//0xf3-Vol-
//0xf4-Vol+

//0x25-minus
//0x26-plus

char key(char key)
{
    unsigned char key_real_code;
    int           pos;

    XQueryKeymap(linux_display, keymap);
    key_real_code=key_table[(unsigned char)key];
    pos=1<<(key_real_code%16-1);

    if(pos&keymap[key_real_code/16])
        return 1;
    return 0;
}

#endif //LINUX

char key_up(unsigned char k)
{
    static char buf[256]={0};
    int i;

    for(i=0; i<256; i++)
    {
        if(buf[i]==1 && k==i && !key(k))
        {
            buf[i]=0;
            return 1;
        }
    }
    if(key(k)) buf[(int)k]=1;

    return 0;
}
